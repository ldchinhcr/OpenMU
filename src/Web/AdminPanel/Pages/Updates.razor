@page "/config-updates"

<h3>Cập nhật cấu hình</h3>

@if (!this.SetupService.IsInstalled || this.SetupService.IsUpdateRequired)
{
    <div class="alert alert-info" role="alert">Vui lòng cài đặt các bản cập nhật cơ sở dữ liệu trên trang <NavLink href="setup">Cài đặt</NavLink> trước.</div>
    return;
}
@if (!this._availableUpdates.Any())
{
    <div class="alert alert-success" role="alert">Không có bản cập nhật dữ liệu cấu hình nào khả dụng.</div>
    return;
}

<div class="alert alert-light">
    <p>Có các bản cập nhật mới cho dữ liệu cấu hình. Bạn có thể chọn những bản cập nhật nào sẽ được áp dụng cho cấu hình của bạn.</p>
    <p>Các bản cập nhật bắt buộc luôn được áp dụng và không thể bỏ chọn.</p>
    <p>Các bản cập nhật yêu cầu khởi động lại quá trình máy chủ để có hiệu lực.</p>
</div>

@foreach (var update in this._availableUpdates)
{
    <div class="alert @(update.State == UpdateState.Failed ? "alert-warning" : update.Selected ? "alert-primary" : "alert-secondary")" role="alert">
        @if (update.State == UpdateState.Started)
        {
            <div class="spinner-border text-secondary spinner-border-sm" role="status">
                <span class="sr-only">Đang cập nhật...</span>
            </div>
        }
        else if (update.State == UpdateState.Failed)
        {
            <span class="oi oi-bolt"></span>
        }
        else if (update.State == UpdateState.Installed)
        {
            <span class="oi oi-check"></span>
        }
        else if (update.IsMandatory)
        {
            <InputCheckbox @bind-Value="@update.Selected" disabled="disabled"></InputCheckbox>
        }
        else
        {
            <InputCheckbox @bind-Value="@update.Selected"></InputCheckbox>
        }
        <span>&nbsp;@update.Name (#@update.Version)</span>
        <hr/>
        <div class="alert alert-secondary">
            <span>@update.Description</span>
        </div>
    </div>
}

@if (this._overallState == UpdateState.Started)
{
    <button class="btn btn-primary" type="button" disabled>
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        Đang áp dụng các bản cập nhật ...
    </button>
}
else if (this._overallState == UpdateState.Failed)
{
    <button class="btn btn-primary" type="button" disabled>
        <span class="oi oi-bolt" role="status" aria-hidden="true"></span>
        Cập nhật thất bại!
    </button>
}
else if (this._availableUpdates.Any(u => u.Selected))
{
    <button class="btn btn-primary" type="button" @onclick="this.OnUpdateClickAsync">Áp dụng các bản cập nhật đã chọn</button>
}
else
{
    <button class="btn btn-primary" type="button" disabled>Áp dụng các bản cập nhật đã chọn</button>
}

@if (this._exception is { } exception)
{
    <hr/>
    <div class="alert alert-danger">
        <h3 class="alert-heading">
            <span class="oi oi-bolt"></span><span>&nbsp;@exception.Message</span>
        </h3>
        <hr/>
        <span>@exception.StackTrace</span>
    </div>
}